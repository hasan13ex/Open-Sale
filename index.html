<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Open Sale — Yerli Elanlar (Firebase)</title>
  <meta name="description" content="Open Sale: Mobil uyumlu elan platformu — Firebase Firestore + Auth ilə real vaxtda elanlar, qeydiyyat, axtarış/filtr, favoritlər (lokal), mesaj (lokal demo)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root{ --bg:#0a1010; --panel:#0f1716; --card:#121c1b; --line:#1f2c2a; --text:#e9f5f2; --muted:#a8c0bb; --brand:#19c37d; --brand2:#12a66a; --accent:#22d3a6; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444 }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(180deg,#091010,#0d1615);color:var(--text);font:15.5px/1.6 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    .container{max-width:1160px;margin:0 auto;padding:14px}

    header{position:sticky;top:0;z-index:40;background:rgba(10,16,16,.75);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
    .nav{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;padding:10px 0}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .badge{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;color:#052018;font-weight:900}
    .search{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:14px;padding:8px 10px;background:rgba(18,28,27,.6)}
    .search input{flex:1;background:transparent;border:0;outline:none;color:var(--text)}
    .actions{display:flex;gap:8px}
    .btn{border:0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#041712}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    .btn.icon{display:grid;place-items:center;padding:10px;min-width:44px}

    .chips{display:flex;gap:8px;overflow:auto;padding:10px 0}
    .chip{white-space:nowrap;border:1px solid var(--line);padding:8px 12px;border-radius:999px;background:#12211f;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:8px}
    .chip i{opacity:.9}
    .chip.active{background:linear-gradient(135deg,rgba(25,195,125,.22),rgba(18,166,106,.18));color:#eafff7;border-color:#2c6c59}

    .layout{display:grid;grid-template-columns:272px 1fr;gap:16px}
    aside{position:sticky;top:82px;align-self:start}
    .card{background:linear-gradient(180deg,rgba(18,28,27,.75),rgba(18,28,27,.45));border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h3{margin:0 0 8px;font-size:16px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0f1a19;color:var(--text)}
    input:focus,select:focus,textarea:focus{outline:2px solid var(--accent)}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .item{overflow:hidden;border-radius:16px;border:1px solid var(--line);background:#0e1918;position:relative}
    .thumb{aspect-ratio:4/3;background:#0b1514;position:relative}
    .badge-vip{position:absolute;left:8px;top:8px;background:linear-gradient(135deg,#ffd54f,#ffb300);color:#3b2d00;padding:4px 8px;border-radius:8px;font-weight:900;border:1px solid rgba(0,0,0,.2)}
    .price{position:absolute;left:8px;bottom:8px;background:rgba(10,16,16,.75);backdrop-filter:blur(6px);border:1px solid var(--line);padding:6px 9px;border-radius:10px;font-weight:800}
    .fav{position:absolute;right:8px;top:8px}
    .meta{padding:10px}
    .ttl{margin:0 0 6px;font-weight:800}
    .sub{margin:0;color:var(--muted);font-size:13px}

    .detail{display:none;grid-template-columns:1fr 360px;gap:16px}
    .detail.active{display:grid}
    .gallery{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .gallery .big{grid-column:1/2}
    .chat{display:grid;gap:10px}
    .bubble{padding:10px 12px;border-radius:14px;max-width:80%}
    .me{justify-self:end;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#041712}
    .other{justify-self:start;background:#0f1a19;border:1px solid var(--line)}

    .sheet{position:fixed;inset:0;background:rgba(5,10,10,.6);display:none;align-items:flex-end;z-index:50}
    .sheet.active{display:flex}
    .panel{width:100%;max-width:520px;margin:0 auto;background:#0f1a19;border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);padding:16px}

    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);margin-bottom:8px}
    .tab{padding:8px 12px;border-radius:10px 10px 0 0;cursor:pointer;color:var(--muted)}
    .tab.active{color:#041712;background:linear-gradient(135deg,var(--brand),var(--brand2))}

    footer{border-top:1px solid var(--line);margin-top:22px;color:var(--muted);font-size:13px}

    @media (max-width:1024px){.layout{grid-template-columns:1fr}.grid{grid-template-columns:repeat(2,1fr)}aside{position:static}.detail{grid-template-columns:1fr}}
    @media (max-width:640px){.nav{grid-template-columns:1fr auto}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <a class="brand" href="#"><div class="badge">OS</div> Open Sale</a>
      <div class="search">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="q" placeholder="Axtar: telefon, kompüter, mənzil..." />
        <button id="fOpen" class="btn ghost"><i class="fa-solid fa-sliders"></i> Filtrlər</button>
        <button id="saveSearch" class="btn ghost" title="Axtarışı saxla"><i class="fa-regular fa-bell"></i></button>
      </div>
      <div class="actions">
        <button id="favBtn" class="btn icon ghost" title="Favorilər"><i class="fa-regular fa-heart"></i></button>
        <button id="msgBtn" class="btn icon ghost" title="Mesajlar"><i class="fa-regular fa-message"></i></button>
        <button id="authBtn" class="btn ghost"><i class="fa-regular fa-user"></i> Giriş / Qeydiyyat</button>
        <button id="postBtn" class="btn primary"><i class="fa-solid fa-plus"></i> Elan yerləşdir</button>
      </div>
    </div>
    <div class="container"><div class="chips" id="cats"></div></div>
  </header>

  <main class="container">
    <div class="layout">
      <aside class="card">
        <h3>Tez filtr</h3>
        <label>Şəhər</label>
        <select id="city"></select>
        <label>Vəziyyət</label>
        <select id="cond"><option value="">Hamısı</option><option>Yeni</option><option>İşlənmiş</option></select>
        <label>Qiymət (AZN)</label>
        <div style="display:flex;gap:8px">
          <input id="min" placeholder="min" inputmode="numeric" />
          <input id="max" placeholder="max" inputmode="numeric" />
        </div>
        <div style="height:8px"></div>
        <button id="apply" class="btn primary" style="width:100%">Tətbiq et</button>
        <button id="reset" class="btn ghost" style="width:100%;margin-top:8px">Sıfırla</button>
        <div style="height:8px"></div>
        <label><input type="checkbox" id="onlyImg" /> Yalnız şəkilli</label>
      </aside>

      <section>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
          <small style="color:var(--muted)">Sıralama:</small>
          <select id="sort">
            <option value="new">Ən yeni</option>
            <option value="cheap">Ən ucuz</option>
            <option value="exp">Ən bahalı</option>
            <option value="popular">Ən populyar</option>
          </select>
          <div style="margin-left:auto;color:var(--muted)" id="count"></div>
        </div>
        <div id="feed" class="grid" aria-live="polite"></div>
        <div id="empty" style="display:none;color:var(--muted);padding:16px">Nəticə tapılmadı.</div>
        <div style="display:flex;justify-content:center;margin-top:10px"><button id="more" class="btn ghost" style="display:none"><i class="fa-solid fa-angles-down"></i> Daha çox yüklə</button></div>
      </section>
    </div>

    <section id="detail" class="detail">
      <div>
        <div class="gallery card" id="gal"></div>
        <div class="card">
          <h2 id="dTitle" style="margin:0 0 6px"></h2>
          <div id="dMeta" class="sub"></div>
          <p id="dDesc" style="margin-top:10px"></p>
          <div id="dStats" class="sub" style="margin-top:6px"></div>
        </div>
      </div>
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong id="dPrice" style="font-size:22px"></strong>
            <button class="btn ghost" onclick="history.back()"><i class="fa-solid fa-arrow-left"></i> Geri</button>
          </div>
          <div style="height:10px"></div>
          <button id="favToggle" class="btn ghost" style="width:100%;margin-bottom:8px"><i class="fa-regular fa-heart"></i> Favorilərə əlavə et</button>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <a id="callBtn" class="btn primary" href="#"><i class="fa-solid fa-phone"></i> Zəng et</a>
            <a id="waBtn" class="btn ghost" href="#" target="_blank"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
          </div>
          <div id="ownerCtl" style="display:none;margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <button id="editAd" class="btn ghost"><i class="fa-regular fa-pen-to-square"></i> Redaktə et</button>
            <button id="delAd" class="btn" style="background:#241112;border:1px solid #3a1a1d"><i class="fa-regular fa-trash-can"></i> Sil</button>
          </div>
          <button id="chatOpen" class="btn primary" style="width:100%;margin-top:8px"><i class="fa-regular fa-message"></i> Satıcıya yaz</button>
          <button id="reportBtn" class="btn ghost" style="width:100%;margin-top:8px"><i class="fa-regular fa-flag"></i> Şikayət et</button>
          <div style="margin-top:8px;color:var(--muted);font-size:13px"><i class="fa-solid fa-shield"></i> Təhlükəsizlik üçün heç vaxt kart məlumatı vermə.</div>
        </div>
        <div class="card" id="sellerBox">
          <div style="display:flex;gap:10px;align-items:center">
            <div class="badge" id="sellerBadge" style="width:44px;height:44px;border-radius:14px">OS</div>
            <div>
              <strong id="sellerName"></strong>
              <div class="sub" id="sellerMeta"></div>
            </div>
          </div>
        </div>
        <div class="card chat" id="chatBox" style="display:none">
          <div id="chatMsgs"></div>
          <div style="display:flex;gap:8px">
            <input id="chatInput" placeholder="Mesaj yaz..." />
            <button id="chatSend" class="btn primary"><i class="fa-solid fa-paper-plane"></i> Göndər</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- SHEETS / MODALS -->
  <div class="sheet" id="sheet">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Filtrlər</strong><button id="fClose" class="btn icon ghost"><i class="fa-solid fa-xmark"></i></button></div>
      <div style="height:8px"></div>
      <label>Kateqoriya</label>
      <div id="mCats" class="chips"></div>
      <label>Şəhər</label>
      <select id="mCity"></select>
      <label>Vəziyyət</label>
      <select id="mCond"><option value="">Hamısı</option><option>Yeni</option><option>İşlənmiş</option></select>
      <label>Qiymət aralığı</label>
      <div style="display:flex;gap:8px"><input id="mMin" placeholder="min" inputmode="numeric"/><input id="mMax" placeholder="max" inputmode="numeric"/></div>
      <div style="height:12px"></div>
      <button id="mApply" class="btn primary" style="width:100%">Tətbiq et</button>
    </div>
  </div>

  <!-- Auth -->
  <div class="sheet" id="auth">
    <div class="panel">
      <div class="tabs"><div class="tab active" data-tab="login"><i class="fa-regular fa-user"></i> Giriş</div><div class="tab" data-tab="register"><i class="fa-solid fa-user-plus"></i> Qeydiyyat</div></div>
      <form id="loginForm" style="display:grid;gap:8px">
        <input name="email" type="email" placeholder="E-poçt" required>
        <input name="pass" type="password" placeholder="Şifrə" required>
        <button class="btn primary" type="submit">Giriş et</button>
        <button id="googleBtn" class="btn ghost" type="button"><i class="fa-brands fa-google"></i> Google ilə daxil ol</button>
      </form>
      <form id="regForm" style="display:none;gap:8px">
        <input name="name" placeholder="Ad Soyad" required>
        <input name="email" type="email" placeholder="E-poçt" required>
        <input name="pass" type="password" placeholder="Şifrə" required>
        <button class="btn primary" type="submit">Qeydiyyatdan keç</button>
      </form>
      <button id="authClose" class="btn ghost" style="margin-top:8px">Bağla</button>
    </div>
  </div>

  <!-- Post Ad -->
  <div class="sheet" id="post">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong id="postTitle">Elan yerləşdir</strong><button id="pClose" class="btn icon ghost"><i class="fa-solid fa-xmark"></i></button></div>
      <form id="postForm" style="display:grid;gap:10px;margin-top:8px">
        <label>Başlıq<input name="title" required placeholder="Məs: iPhone 12 128GB"/></label>
        <label>Təsvir<textarea name="desc" rows="4" placeholder="Məhsul haqqında məlumat..."></textarea></label>
        <label>Qiymət (AZN)<input name="price" required inputmode="numeric"/></label>
        <label>Şəhər<select name="city"></select></label>
        <label>Kateqoriya<select name="cat"></select></label>
        <label>Vəziyyət<select name="cond"><option>Yeni</option><option>İşlənmiş</option></select></label>
        <label>Telefon nömrəsi<input name="phone" required placeholder="0501234567"/></label>
        <label><input type="checkbox" name="whatsapp"/> WhatsApp mövcuddur</label>
        <label>Şəkillər (1–5)<input name="imgs" type="file" accept="image/*" multiple /></label>
        <label><input type="checkbox" name="vip"/> VIP (öndə göstər)</label>
        <input type="hidden" name="editId" />
        <button class="btn primary" type="submit"><i class="fa-solid fa-cloud-arrow-up"></i> Yadda saxla</button>
      </form>
    </div>
  </div>

  <!-- Favorites / Messages -->
  <div class="sheet" id="favSheet"><div class="panel"><div style="display:flex;justify-content:space-between;align-items:center"><strong>Favorilər</strong><button id="favClose" class="btn icon ghost"><i class="fa-solid fa-xmark"></i></button></div><div id="favList" style="display:grid;gap:10px;margin-top:8px"></div></div></div>
  <div class="sheet" id="msgSheet"><div class="panel"><div style="display:flex;justify-content:space-between;align-items:center"><strong>Mesaj qutusu</strong><button id="msgClose" class="btn icon ghost"><i class="fa-solid fa-xmark"></i></button></div><div id="threadList" style="display:grid;gap:10px;margin-top:8px"></div></div></div>

  <footer class="container">© <span id="yil"></span> Open Sale — Firebase demo (elanlar Firestore-da saxlanılır).</footer>

  <!-- Firebase SDK (compat CDN) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>

  <script>
    // 🔥 Sənin real konfiqin
    const firebaseConfig = {
      apiKey: "AIzaSyA0OKOep7j5q-rHyfrpIgIXVGHSpEm29S8",
      authDomain: "opensale-c9f5a.firebaseapp.com",
      projectId: "opensale-c9f5a",
      storageBucket: "opensale-c9f5a.firebasestorage.app", // Storage-dan hələ istifadə etmirik
      messagingSenderId: "195119410792",
      appId: "1:195119410792:web:2aad812d705182b42955dd",
      measurementId: "G-ZMQ70VCJNN"
    };

    // Firebase başlat
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
  </script>

  <script>
    // ====== UTIL ======
    const STORE = { get(k,d){ try{return JSON.parse(localStorage.getItem(k)) ?? d}catch(e){return d} }, set(k,v){ localStorage.setItem(k, JSON.stringify(v)) } };
    const state = { q:'', cat:'', city:'', cond:'', min:'', max:'', onlyImg:false, sort:'new', me:null, viewing:null, page:1, perPage:9, ads:[] };

    const CATS = [
      {name:"Telefonlar", icon:"fa-mobile-screen"},
      {name:"Kompüterlər", icon:"fa-computer"},
      {name:"Daşınmaz əmlak", icon:"fa-house"},
      {name:"Avtomobillər", icon:"fa-car"},
      {name:"Uşaq dünyası", icon:"fa-baby"},
      {name:"Ev əşyaları", icon:"fa-couch"},
      {name:"İdman", icon:"fa-dumbbell"},
      {name:"Oyunlar", icon:"fa-gamepad"},
      {name:"Moda", icon:"fa-shirt"},
      {name:"Heyvanlar", icon:"fa-paw"},
      {name:"Digər", icon:"fa-grid-2"}
    ];

    const CITIES = ["Bakı","Gəncə","Sumqayıt","Şirvan","Lənkəran","Mingəçevir","Naxçıvan","Quba","Qusar","Xaçmaz","Şəki","Zaqatala","Qax","Qəbələ","İsmayıllı","Şamaxı","Ağsu","Salyan","Neftçala","Biləsuvar","Cəlilabad","Masallı","Astara","Yardımlı","Lerik","Beyləqan","Füzuli","Şuşa","Xankəndi","Ağdam","Tərtər","Yevlax","Bərdə","Goranboy","Göyçay","Ucar","Ağdaş","Zərdab","Ağcabədi","Sabirabad","Hacıqabul","Qazax","Tovuz","Şəmkir","Gədəbəy","Daşkəsən","Samux","Balakən","Oğuz","Kürdəmir","Saatlı","Siyəzən","Şabran","Qobustan","Abşeron","Xızı","Naftalan","Şirvan","Lökbatan","Sumqayıt","Xırdalan"];

    // Elelement refs
    const feed = document.getElementById('feed'), empty = document.getElementById('empty'), count = document.getElementById('count'), moreBtn = document.getElementById('more');
    const cats = document.getElementById('cats'), mCats = document.getElementById('mCats');
    const q = document.getElementById('q'), sort = document.getElementById('sort'), onlyImg = document.getElementById('onlyImg');
    const city = document.getElementById('city'), cond = document.getElementById('cond'), min = document.getElementById('min'), max = document.getElementById('max');
    const sheet = document.getElementById('sheet'), mCity = document.getElementById('mCity'), mCond = document.getElementById('mCond'), mMin = document.getElementById('mMin'), mMax = document.getElementById('mMax');

    const post = document.getElementById('post'), postBtn = document.getElementById('postBtn'), pClose = document.getElementById('pClose'), postForm = document.getElementById('postForm'), postTitle = document.getElementById('postTitle');
    const favBtn = document.getElementById('favBtn'), favSheet = document.getElementById('favSheet'), favClose = document.getElementById('favClose'), favList = document.getElementById('favList');
    const msgBtn = document.getElementById('msgBtn'), msgSheet = document.getElementById('msgSheet'), msgClose = document.getElementById('msgClose'), threadList = document.getElementById('threadList');

    const authSheet = document.getElementById('auth'), authBtn = document.getElementById('authBtn'), authClose = document.getElementById('authClose');
    const loginForm = document.getElementById('loginForm'), regForm = document.getElementById('regForm');

    const detail = document.getElementById('detail'), gal = document.getElementById('gal'), dTitle = document.getElementById('dTitle'), dMeta = document.getElementById('dMeta'), dDesc = document.getElementById('dDesc'), dPrice = document.getElementById('dPrice'), favToggle = document.getElementById('favToggle'), chatOpen = document.getElementById('chatOpen'), chatBox = document.getElementById('chatBox'), chatMsgs = document.getElementById('chatMsgs'), chatInput = document.getElementById('chatInput'), chatSend = document.getElementById('chatSend');
    const callBtn = document.getElementById('callBtn'), waBtn = document.getElementById('waBtn'), ownerCtl = document.getElementById('ownerCtl'), editAdBtn = document.getElementById('editAd'), delAdBtn = document.getElementById('delAd');
    const sellerName = document.getElementById('sellerName'), sellerMeta = document.getElementById('sellerMeta');

    document.getElementById('yil').textContent = new Date().getFullYear();

    function renderChips(target, current){ target.innerHTML=''; CATS.forEach(c=>{ const b=document.createElement('button'); b.className='chip'+(current===c.name?' active':''); b.innerHTML=`<i class="fa-solid ${c.icon}"></i> ${c.name}`; b.onclick=()=>{ state.cat=(state.cat===c.name?'':c.name); state.page=1; syncFilters(); draw(true) }; target.appendChild(b) }) }
    function fillCities(){ const opts=['<option value="">Hamısı</option>'].concat(CITIES.map(c=>`<option>${c}</option>`)).join(''); city.innerHTML=opts; mCity.innerHTML=opts }
    function syncFilters(){ city.value=state.city; cond.value=state.cond; min.value=state.min; max.value=state.max; onlyImg.checked=state.onlyImg; sort.value=state.sort; mCity.value=state.city; mCond.value=state.cond; mMin.value=state.min; mMax.value=state.max; renderChips(cats, state.cat); renderChips(mCats, state.cat) }
    function ago(ts){ if(!ts) return ''; const s=Math.floor((Date.now()-ts)/1000); if(s<60) return 'İndicə'; const m=Math.floor(s/60); if(m<60) return m+' dəq əvvəl'; const h=Math.floor(m/60); if(h<24) return h+' saat əvvəl'; const d=Math.floor(h/24); return d+' gün əvvəl' }
    function money(n){ return (n||0).toLocaleString('az-Latn-AZ') }
    function notify(text){ const n=document.createElement('div'); n.innerHTML=`<i class="fa-solid fa-check"></i> ${text}`; n.style.cssText='position:fixed;left:50%;top:20px;transform:translateX(-50%);background:linear-gradient(135deg,var(--brand),var(--brand2));color:#041712;padding:10px 14px;border-radius:12px;font-weight:800;z-index:70'; document.body.appendChild(n); setTimeout(()=>n.remove(),1600) }

    // ====== FIRESTORE HELPERS ======
    const Ads = {
      listen(cb){ return db.collection('ads').orderBy('createdAt','desc').onSnapshot(s=>{ state.ads = s.docs.map(d=> ({id:d.id, ...d.data()})); cb(); }) },
      async add(doc){ return db.collection('ads').add(doc) },
      async update(id, patch){ return db.collection('ads').doc(id).update(patch) },
      async remove(id){ return db.collection('ads').doc(id).delete() }
    };

    const Users = {
      async upsertProfile(u){ if(!u) return; const ref = db.collection('users').doc(u.uid); const snap = await ref.get(); const base = { name: u.displayName || (u.email||'').split('@')[0], email: u.email, rating: 5, lastSeen: Date.now() }; if(snap.exists) await ref.update({ lastSeen: Date.now() }); else await ref.set(base) },
      async get(uid){ const d = await db.collection('users').doc(uid).get(); return d.exists? d.data(): null }
    };

    // ====== FEED & FILTER ======
    function filtered(){ let list=[...state.ads]; if(state.q) list=list.filter(x=> ((x.title||'')+" "+(x.desc||'')).toLowerCase().includes(state.q.toLowerCase())); if(state.cat) list=list.filter(x=> x.cat===state.cat); if(state.city) list=list.filter(x=> x.city===state.city); if(state.cond) list=list.filter(x=> x.cond===state.cond); if(state.min) list=list.filter(x=> (x.price||0)>= +state.min); if(state.max) list=list.filter(x=> (x.price||0)<= +state.max); if(state.onlyImg) list=list.filter(x=> x.imgs && x.imgs.length); if(state.sort==='cheap') list.sort((a,b)=>(a.price||0)-(b.price||0)); if(state.sort==='exp') list.sort((a,b)=>(b.price||0)-(a.price||0)); if(state.sort==='new') list.sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0)); if(state.sort==='popular') list.sort((a,b)=> (b.views||0)-(a.views||0) ); list.sort((a,b)=> (b.vip?1:0)-(a.vip?1:0) ); return list }

    function draw(reset){ const list=filtered(); const total=list.length; count.textContent= total + ' elan'; empty.style.display = total? 'none':'block'; const end= state.page*state.perPage; const slice=list.slice(0,end); if(reset) feed.innerHTML=''; slice.forEach(x=> feed.appendChild(card(x))); moreBtn.style.display = end < total ? 'inline-block' : 'none' }

    function card(x){ const a=document.createElement('article'); a.className='item'; const img = x.imgs && x.imgs[0] ? `<img src="${x.imgs[0]}" alt="${x.title}">` : '';
      const when = x.createdAt?.toMillis? ago(x.createdAt.toMillis()) : '';
      a.innerHTML=`<div class="thumb">${x.vip?'<div class="badge-vip"><i class="fa-solid fa-star"></i> VIP</div>':''}${img}<div class="price">${money(x.price)} AZN</div><button class="btn icon ghost fav" title="Favori"><i class="fa-regular fa-heart"></i></button></div><div class="meta"><h4 class="ttl">${x.title||''}</h4><p class="sub">${x.city||''} • ${x.cond||''} • ${when}${x.views? ' • '+x.views+' baxış' : ''}</p></div>`;
      a.querySelector('.fav').onclick = (e)=>{ e.stopPropagation(); toggleFav(x.id); };
      a.onclick=()=> openDetail(x.id);
      return a }

    async function openDetail(id){ const x = state.ads.find(i=>i.id===id); if(!x) return; state.viewing=id; // views +1
      Ads.update(id, { views: (x.views||0)+1 });
      document.querySelector('.layout').style.display='none'; detail.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'});
      gal.innerHTML = (x.imgs||[]).map((u,i)=>`<img class="${i===0?'big':''}" src="${u}" alt="${x.title} ${i+1}" style="border-radius:12px">`).join('');
      dTitle.textContent=x.title||''; const when = x.createdAt?.toMillis? ago(x.createdAt.toMillis()) : ''; dMeta.textContent = `${x.city||''} • ${x.cond||''} • ${when} • Kateqoriya: ${x.cat||''}`; dDesc.textContent=x.desc||''; dPrice.textContent= money(x.price)+' AZN'; document.getElementById('dStats').textContent = `${(x.views||0)} baxış`;
      const f = isFav(x.id); favToggle.innerHTML = (f? '<i class="fa-solid fa-heart"></i> Favorilərdə' : '<i class="fa-regular fa-heart"></i> Favorilərə əlavə et');
      const u = x.uid? await Users.get(x.uid) : {name:'İstifadəçi',rating:5,lastSeen:Date.now()};
      sellerName.textContent = (u?.name||'İstifadəçi') + (x.vip? ' • təsdiqlənmiş' : '');
      sellerMeta.innerHTML = `<i class="fa-regular fa-face-smile"></i> Reytinq: ${(u?.rating||5).toFixed(1)} ★ • Son aktivlik: ${ago(u?.lastSeen||Date.now())}`;
      callBtn.href = x.phone? `tel:${x.phone}` : '#'; callBtn.style.pointerEvents = x.phone? 'auto':'none'; callBtn.style.opacity = x.phone? '1':'.5';
      waBtn.href = (x.phone && x.whatsapp)? `https://wa.me/994${x.phone.replace(/[^0-9]/g,'').replace(/^0/,'')}` : '#'; waBtn.style.pointerEvents = (x.phone&&x.whatsapp)?'auto':'none'; waBtn.style.opacity = (x.phone&&x.whatsapp)?'1':'.5';
      if(state.me && state.me.uid===x.uid){ ownerCtl.style.display='grid'; editAdBtn.onclick=()=> editAd(x.id); delAdBtn.onclick=()=> delAd(x.id) } else ownerCtl.style.display='none';
      history.pushState({id:x.id}, '', '#elan-'+x.id); const onPop = ()=>{ detail.classList.remove('active'); document.querySelector('.layout').style.display='grid'; window.removeEventListener('popstate', onPop) }; window.addEventListener('popstate', onPop);
      chatBox.style.display='none'; drawChat();
    }

    // ====== FAVORITES (lokal qalır) ======
    function favKey(){ return state.me? `fav:${state.me.uid}` : 'fav:qonaq' }
    function getFav(){ return STORE.get(favKey(), {}) }
    function setFav(v){ STORE.set(favKey(), v) }
    function isFav(id){ return !!getFav()[id] }
    function toggleFav(id){ const f=getFav(); if(f[id]) delete f[id]; else f[id]=true; setFav(f); notify(f[id]?'Favorilərə əlavə olundu':'Favorilərdən silindi'); const x=state.viewing; if(x){ const fav=isFav(x); favToggle.innerHTML=fav?'<i class="fa-solid fa-heart"></i> Favorilərdə':'<i class="fa-regular fa-heart"></i> Favorilərə əlavə et' } drawFavList() }
    function drawFavList(){ const f=getFav(); const all=state.ads.filter(i=>f[i.id]); favList.innerHTML=''; if(!all.length){ favList.innerHTML='<div style="color:var(--muted)">Favori yoxdur.</div>'; return } all.forEach(x=>{ const row=document.createElement('div'); row.className='card'; row.style.display='grid'; row.style.gridTemplateColumns='80px 1fr auto'; row.style.gap='10px'; row.innerHTML=`<img src="${(x.imgs||[])[0]||''}" style="width:80px;height:60px;object-fit:cover;border-radius:10px"><div><strong>${x.title}</strong><div class="sub">${money(x.price)} AZN • ${x.city}</div></div><button class="btn ghost"><i class="fa-solid fa-up-right-from-square"></i> Aç</button>`; row.querySelector('button').onclick=()=>{ favSheet.classList.remove('active'); openDetail(x.id) }; favList.appendChild(row) }) }

    // ====== MESSAGING (lokal demo) ======
    function threadKey(adId){ return `msgs:${adId}` }
    function getThread(adId){ return STORE.get(threadKey(adId), []) }
    function pushMsg(adId, msg){ const t=getThread(adId); t.push(msg); STORE.set(threadKey(adId), t) }
    function drawChat(){ const id=state.viewing; if(!id) return; const t=getThread(id); chatMsgs.innerHTML=''; t.forEach(m=>{ const b=document.createElement('div'); b.className='bubble '+(m.uid===state.me?.uid?'me':'other'); b.textContent=m.text; chatMsgs.appendChild(b) }); chatMsgs.scrollTop=chatMsgs.scrollHeight }

    function sendChat(){ const id=state.viewing; if(!id) return; const txt=chatInput.value.trim(); if(!txt) return; if(!state.me){ authSheet.classList.add('active'); return } const msg={ at:Date.now(), uid:state.me.uid, text:txt }; pushMsg(id, msg); chatInput.value=''; drawChat(); notify('Mesaj göndərildi') }

    // ====== AUTH (Firebase) ======
    function setMe(u){ state.me=u; if(u){ authBtn.innerHTML = `<i class=\"fa-regular fa-user\"></i> ${ (u.displayName||u.email).split('@')[0] } • Çıxış` } else { authBtn.innerHTML = '<i class="fa-regular fa-user"></i> Giriş / Qeydiyyat' } }

    auth.onAuthStateChanged(async (u)=>{ setMe(u||null); if(u){ await Users.upsertProfile(u) } });

    // ====== CRUD (Post/Edit/Delete) ======
    async function filesToDataURLs(fileList){ const files=[...fileList].slice(0,5); const arr=[]; for(const f of files){ arr.push(await new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(f) })) } return arr }

    function editAd(id){ const x=state.ads.find(i=>i.id===id); if(!x) return; postTitle.textContent='Elanı redaktə et'; post.classList.add('active'); const f=postForm; f.elements['title'].value=x.title||''; f.elements['desc'].value=x.desc||''; f.elements['price'].value=x.price||''; f.elements['city'].value=x.city||''; f.elements['cat'].value=x.cat||''; f.elements['cond'].value=x.cond||'İşlənmiş'; f.elements['phone'].value=x.phone||''; f.elements['whatsapp'].checked=!!x.whatsapp; f.elements['vip'].checked=!!x.vip; f.elements['editId'].value=x.id }

    async function delAd(id){ if(!confirm('Elanı silmək istəyirsən?')) return; await Ads.remove(id); notify('Elan silindi'); history.back(); draw(true) }

    // ====== UI ACTIONS & INIT ======
    document.getElementById('yil').textContent = new Date().getFullYear();

    function init(){
      renderChips(cats, state.cat); renderChips(mCats, state.cat); fillCities(); syncFilters();
      sort.addEventListener('change', ()=>{state.sort=sort.value; state.page=1; draw(true)}); onlyImg.addEventListener('change',()=>{state.onlyImg=onlyImg.checked; state.page=1; draw(true) })
      document.getElementById('apply').onclick=()=>{state.city=city.value; state.cond=cond.value; state.min=min.value; state.max=max.value; state.page=1; draw(true)}
      document.getElementById('reset').onclick=()=>{ Object.assign(state,{q:'',cat:'',city:'',cond:'',min:'',max:'',onlyImg:false,sort:'new',page:1}); q.value=''; syncFilters(); draw(true) }
      document.getElementById('fOpen').onclick=()=> sheet.classList.add('active'); document.getElementById('fClose').onclick=()=> sheet.classList.remove('active');
      document.getElementById('mApply').onclick=()=>{ state.city=mCity.value; state.cond=mCond.value; state.min=mMin.value; state.max=mMax.value; sheet.classList.remove('active'); state.page=1; draw(true) }

      // Axtarış
      q.addEventListener('input', ()=>{ state.q=q.value; draw(true) });
      document.getElementById('saveSearch').onclick = ()=>{ const saved=STORE.get('savedSearches',[]); const rule={q:state.q,cat:state.cat,city:state.city,cond:state.cond,min:state.min,max:state.max,ts:Date.now()}; saved.push(rule); STORE.set('savedSearches', saved); notify('Axtarış saxlandı') }

      // Elan yerləşdir
      postBtn.onclick=()=>{ if(!state.me){ authSheet.classList.add('active'); notify('Elan yerləşdirmək üçün giriş et.'); return } postTitle.textContent='Elan yerləşdir'; postForm.reset(); post.classList.add('active') }
      pClose.onclick=()=> post.classList.remove('active')
      const citySel=postForm.elements['city'], catSel=postForm.elements['cat']; CITIES.forEach(c=>{ const o=document.createElement('option'); o.textContent=c; citySel.appendChild(o) }); CATS.forEach(c=>{ const o=document.createElement('option'); o.textContent=c.name; catSel.appendChild(o) })

      postForm.onsubmit= async (e)=>{ e.preventDefault(); if(!state.me) return authSheet.classList.add('active'); const f=new FormData(postForm); const editId=f.get('editId'); const imgs= await filesToDataURLs(f.getAll('imgs'));
        const base={ title:f.get('title'), desc:f.get('desc')||'', price:+f.get('price')||0, city:f.get('city'), cond:f.get('cond'), cat:f.get('cat'), phone:(f.get('phone')||'').trim(), whatsapp: !!f.get('whatsapp'), vip: !!f.get('vip') };
        if(editId){ await Ads.update(editId, { ...base, ...(imgs.length? {imgs}: {}) }); notify('Elan yeniləndi') }
        else{ await Ads.add({ ...base, uid: state.me.uid, imgs, views:0, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); notify('Elan dərc olundu') }
        postForm.reset(); post.classList.remove('active'); state.page=1; draw(true) }

      // Favorites & Messages
      favBtn.onclick=()=>{ drawFavList(); favSheet.classList.add('active') }; favClose.onclick=()=> favSheet.classList.remove('active');
      msgBtn.onclick=()=>{ drawThreads(); msgSheet.classList.add('active') }; msgClose.onclick=()=> msgSheet.classList.remove('active')

      // Auth UI
      authBtn.onclick=()=>{ if(state.me){ auth.signOut(); notify('Çıxış edildi'); return } authSheet.classList.add('active') }
      authClose.onclick=()=> authSheet.classList.remove('active')
      document.querySelectorAll('.tab').forEach(t=> t.onclick=()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); const k=t.dataset.tab; loginForm.style.display = (k==='login')?'grid':'none'; regForm.style.display = (k==='register')?'grid':'none' })

      // Email/Password login
      loginForm.onsubmit = async (e)=>{ e.preventDefault(); const f=new FormData(loginForm); const email=f.get('email'), pass=f.get('pass'); try{ await auth.signInWithEmailAndPassword(email, pass); authSheet.classList.remove('active'); notify('Xoş gəldin'); }catch(err){ notify('Giriş alınmadı: '+err.message) } }

      // Google login
      document.getElementById('googleBtn').onclick = async ()=>{ try{ const prov = new firebase.auth.GoogleAuthProvider(); await auth.signInWithPopup(prov); authSheet.classList.remove('active'); notify('Google ilə daxil oldun'); }catch(err){ notify('Xəta: '+err.message) } }

      // Register + email verification
      regForm.onsubmit = async (e)=>{ e.preventDefault(); const f=new FormData(regForm); const name=f.get('name'), email=f.get('email'), pass=f.get('pass'); try{ const {user} = await auth.createUserWithEmailAndPassword(email, pass); await user.updateProfile({ displayName: name }); await Users.upsertProfile(user); try{ await user.sendEmailVerification(); }catch(_){} authSheet.classList.remove('active'); notify('Qeydiyyat tamamlandı. E-poçtunuzu təsdiqləyin.'); }catch(err){ notify('Xəta: '+err.message) } }

      favToggle.onclick=()=>{ if(!state.viewing) return; toggleFav(state.viewing) }
      chatOpen.onclick=()=>{ if(!state.me){ authSheet.classList.add('active'); return } chatBox.style.display='grid' }
      chatSend.onclick=()=> sendChat(); chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat() } })

      moreBtn.onclick=()=>{ state.page++; draw(false) }

      // Real-time elanlar
      Ads.listen(()=>{ draw(true); if(location.hash.startsWith('#elan-')){ const id=location.hash.substring(6); openDetail(id) } });

      if(location.hash.startsWith('#elan-')){ const id=location.hash.substring(6); openDetail(id) }
    }

    // Saved searches → Threads (lokal demo üçün)
    function drawThreads(){ const threads=[]; state.ads.forEach(ad=>{ const t=getThread(ad.id); if(t.length){ threads.push({ad, last:t[t.length-1]}) } }); threadList.innerHTML=''; if(!threads.length){ threadList.innerHTML='<div style="color:var(--muted)">Mesaj yoxdur.</div>'; return } threads.sort((a,b)=>b.last.at-a.last.at); threads.forEach(row=>{ const div=document.createElement('div'); div.className='card'; div.style.display='grid'; div.style.gridTemplateColumns='80px 1fr auto'; div.style.gap='10px'; div.innerHTML=`<img src="${(row.ad.imgs||[])[0]||''}" style="width:80px;height:60px;object-fit:cover;border-radius:10px"><div><strong>${row.ad.title}</strong><div class="sub">${new Date(row.last.at).toLocaleString()}</div><div class="sub">${row.last.text}</div></div><button class="btn ghost"><i class="fa-solid fa-up-right-from-square"></i> Aç</button>`; div.querySelector('button').onclick=()=>{ msgSheet.classList.remove('active'); openDetail(row.ad.id); chatBox.style.display='grid' }; threadList.appendChild(div) }) }

    init();
  </script>
</body>
</html>
